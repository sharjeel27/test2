#!/bin/bash
server=`ifconfig | awk -F':' '/inet addr/&&!/127.0.0.1/{split($2,_," ");print _[1]}'`
HARD_LOG="/var/log/${server}_hard_log"
#echo -n "Please Enter Your Name: "
#read NAME
#echo ":Enter your Name" $NAME >>${HARD_LOG}
echo "Please wait.....Hardening is in progess"
echo " Creating Directory Called /etc/BackupSystemFiles for Backup of critical files and files copying are in progress" >> ${HARD_LOG}
mkdir /etc/BackupSystemFiles 
cd / 
tar -cvf /etc/BackupSystemFiles/etc.tar etc &>/dev/null
sleep 10
echo "Files have been copied to /etc/BackupSystemFiles " >>${HARD_LOG}
#######Lock the Unneccessary Accounts########
echo "Locking the Uneccessary Accounts">>${HARD_LOG}
cp -p /etc/passwd /etc/BackupSystemFiles/passwd.prehard
for USERID in rpc rpcuser lp named dns mysql postgres squid news netdump
do
usermod -L -s /sbin/nologin $USERID &>/dev/null
done
echo "********************************************************************************">> ${HARD_LOG}

#######Block System Accounts#######
#cp -p /etc/passwd /etc/BackupSystemFiles/passwd.prehard
for NAME in `cut -d: -f1 /etc/passwd`;
do
MyUID=`id -u $NAME`
if [ $MyUID -lt 1000 -a $NAME != 'root' ]; then
usermod -L -s /sbin/nologin $NAME
fi
done
######Verify passwd, shadow and group file permissions#######
cd /etc
ls -l > /etc/BackupSystemFiles/etc.files

######Verify that no UID 0 Account exists Other than root######
echo "**************************************************************">> ${HARD_LOG}
awk -F: '($3 == 0) { print "UID 0 Accounts are Below. Please do block if its not neccessary\n" $1 }' /etc/passwd>> ${HARD_LOG}
echo "**************************************************************">> ${HARD_LOG}


######Banner#####

cat > /etc/motd << EOF

##################################################################
|This system is for the use of authorized users only. 		 |
|Individuals using this computer system without authority, or in |
|excess of their authority, are subject to having all of their   |
|activities on this system monitored and recorded by system      |
|personnel. 							 |
|In the course of monitoring individuals improperly using this   |
|system, or in the course of system maintenance, the activities  |
|of authorized users may also be monitored.                      |
|Anyone using this system expressly consents to such monitoring  |
|and is advised that if such monitoring reveals possible         |
|evidence of criminal activity, system personnel may provide the |
evidence of such monitoring to law enforcement officials.       |
##################################################################
EOF

cp -p /etc/issue.net /etc/BackupSystemFiles/issue.net.prehard
cp -p /etc/issue /etc/BackupSystemFiles/issue.prehard
cat /etc/motd > /etc/issue.net
cat /etc/motd > /etc/issue

echo "##########################ADDITIONAL LINES###################" >>/etc/sysctl.conf

echo "net.ipv4.conf.all.rp_filter = 1" >> /etc/sysctl.conf
echo "net.ipv4.conf.default.rp_filter = 1 " >> /etc/sysctl.conf
echo "net.ipv4.conf.all.accept_source_route = 0" >> /etc/sysctl.conf
echo "net.ipv4.conf.all.accept_redirects = 0" >> /etc/sysctl.conf
echo "net.ipv4.conf.default.secure_redirects = 0" >> /etc/sysctl.conf
echo "net.ipv4.conf.all.secure_redirects = 0" >> /etc/sysctl.conf
echo "net.ipv4.conf.default.accept_redirects = 0" >> /etc/sysctl.conf
echo "net.ipv4.ip_forward = 0" >> /etc/sysctl.conf
echo "net.ipv4.conf.all.send_redirects = 0" >> /etc/sysctl.conf
echo "net.ipv4.conf.default.send_redirects = 0" >> /etc/sysctl.conf
#net.ipv4.tcp_max_syn_backlog = 2048 >> /etc/sysctl.conf

 echo "net.ipv4.conf.default.accept_source_route = 0 "  >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 4096" >>  /etc/sysctl.conf

echo "net.ipv4.icmp_echo_ignore_broadcasts = 1"  >>  /etc/sysctl.conf
echo " net.ipv4.icmp_ignore_bogus_error_responses=1 "  >>  /etc/sysctl.conf
echo "net.ipv4.icmp_echo_igNore_broadcasts = 1"  >>  /etc/sysctl.conf
echo "net.ipv4.conf.all.log_martians = 1 " >>  /etc/sysctl.conf
echo "net.ipv4.conf.default.log_martians = 1 " >>  /etc/sysctl.conf


echo "net.ipv4.icmp_igNore_bogus_error_messages = 1 "  >>  /etc/sysctl.conf
echo "net.ipv4.tcp_syncookies = 1" >> /etc/sysctl.conf
echo "net.ipv6.conf.all.accept_ra = 0  " >> /etc/sysctl.conf
echo "net.ipv6.conf.default.accept_ra = 0 "  >> /etc/sysctl.conf
echo "net.ipv6.conf.all.accept_redirects = 0 " >> /etc/sysctl.conf
echo "net.ipv6.conf.default.accept_redirects = 0 " >> /etc/sysctl.conf
echo " net.ipv6.conf.all.disable_ipv6 = 1 " >> /etc/sysctl.conf

/sbin/sysctl -w net.ipv4.route.flush=1

echo "kernel.exec-shield = 1" >> /etc/sysctl.conf
echo "kernel.randomize_va_space = 2" >> /etc/sysctl.conf

/sbin/sysctl -p /etc/sysctl.conf

#######################Audit Rules #####################################

echo "-w /var/run/utmp -p wa -k session"  >> /etc/audit/audit.rules
echo  "-w /var/log/btmp -p wa -k session"  >> /etc/audit/audit.rules
echo  "-w /var/log/wtmp -p wa -k session" >> /etc/audit/audit.rules

########Check if auditd services is running#########
chkconfig --level 0123456 auditd on
systemctl enable auditd.service
systemctl status  auditd.service



########################Resolv.conf######################################

echo "nameserver     10.66.15.201" >> /etc/resolv.conf
echo "nameserver     10.66.9.204 " >> /etc/resolv.conf


###################PAM Configuration setting #################################

cp -p /etc/pam.d/su /etc/BackupSystemFiles/
echo "Updating file  /etc/pam.d/su"
cp -p /etc/pam.d/su /etc/BackupSystemFiles/
/bin/sed -r 's/^#(.*required\s+pam_wheel\.so use_uid.*)/\1/' /etc/pam.d/su > /etc/pam.d/su1
mv /etc/pam.d/su1 /etc/pam.d/su
/bin/sed -r 's/^#(.*required\s+pam_wheel\.so use_uid.*)/\1/' /etc/pam.d/su

##########################################################################
#mount -o remount,nodev /tmp
#mount -o remount,nosuid /tmp
#mount -o remount,noexec /tmp
#mount -o remount,nodev /home
#mount -o remount,nodev /dev/shm
#mount -o remount,nosuid /dev/shm
#mount -o remount,noexec /dev/shm

cd /etc/
cp -p fstab /etc/BackupSystemFiles/fstab.prehard
####edit the line with Follwing value###

sed -i '/tmp\s/ s/defaults/Noexec,Nosuid,Nodev/' /etc/fstab 

#########################configure rsyslog file ##########################

cp -p /etc/rsyslog.conf /etc/BackupSystemFiles/rsyslog.conf.prehard
echo "# The authpriv file has restricted access." >> /etc/rsyslog.conf
echo "auth.*,user.*             /var/log/messages" >> /etc/rsyslog.conf


chmod 0644 /etc/at.allow

#cp /etc/audit/auditd.conf /etc/audit/audit.conf


###################################### CRON FILES ##############################
touch /etc/cron.allow
touch /etc/at.allow
chown root:root /etc/cron.allow 
chown root:root /etc/at.allow

rm -rf /etc/at.deny
rm -rf  /etc/cron.deny

echo "root" >> /etc/cron.allow
echo "root" >> /etc/at.allow

###########################Permission and change and Modify owner and group##############

chown root:root /etc/grub.conf
chown root:root /etc/cron.d
chown root:root /etc/cron.hourly
chown root:root /etc/cron.daily 
chown root:root /etc/cron.weekly 
chown root:root /etc/cron.monthly 
chown root:root /etc/cron.allow
chown root:root /etc/ssh/sshd_config
chown root:root /etc/rsyslog.conf
chown root:root /etc/motd
chown root:root /etc/issue
chown root:root /etc/issue.net
chown root:root /etc/passwd
chown root:root /etc/shadow
chown root:root /etc/gshadow
chown root:root /etc/group
chown root:root /var/log/btmp
chown root:root 
chown root:root /var/log/lastlog
chown root:root /var/log/messages
chown root:root /var/log/sa
chown root:root /var/log/samba
chown root:root /etc/cron.allow

###############################################################################
chmod 0600 /etc/cron.d
chmod 0751 /var/log/
chmod og-rwx /etc/cron.hourly
chmod og-rwx /etc/cron.daily
chmod og-rwx /etc/cron.weekly
chmod og-rwx /etc/cron.monthly
chmod og-rwx /etc/cron.allow
chmod 0600 /etc/ssh/sshd_config
chmod 0644 /etc/motd
chmod 0644 /etc/issue
chmod 0644 /etc/issue.net
chmod 0400 /etc/shadow
chmod 0644 /etc/group
chmod 0444 /etc/passwd
chmod 0400 /etc/gshadow
chmod 0644 /var/log/btmp
chmod 0600 /var/log/wtmp
chmod 0644 /var/log/lastlog
chmod 0600 /var/log/messages
chmod 0644 /var/log/sa
chmod 0644 /var/log/samba
chmod 0750 /etc/abrt
chmod 0750 /var/lib/nfs
#chmod 0750 /var/lib/qpidd
chmod 0644 /etc/crontab
chmod 0644 /etc/inittab
chmod 700 /etc/rsyslog.conf
chmod 0644 /etc/sysctl.conf
chmod 750 /etc/pam.d/
chmod 751 /etc/sysconfig/
chmod 644 /etc/hosts.allow
chmod 644 /etc/hosts.deny
chmod 0600 /etc/securetty
chmod 0644 /var/spool/cron/
chmod 750 /etc/pam.d/
chmod 751 /var/log/
chmod 751 /etc/sysconfig/
chmod 0644 /etc/passwd
chmod 777 /etc/cron.deny

touch /etc/cron.allow
chmod 400 /etc/at.allow
chmod 400 /etc/cron.allow
chmod 600 /wtmp
chmod 400 /etc/shadow


##############################################################################
service sysstat restart
/bin/systemctl  restart  sysstat.service
chkconfig --level 0123456 sysstat on
systemctl enable sysstat.service

chmod 0600 /var/log/wtmp
echo "/sbin/chmod 0600 /var/log/wtmp" >> /etc/rc.local


echo "********************************************************************************">> ${HARD_LOG}
echo "Setting Password Expiry Time for users ..." >> ${HARD_LOG}
cp /etc/login.defs /etc/BackupSystemFiles/login.defs.prehard
cd /etc
sed -e 's/99999/45/g' login.defs > login.defs1
cp login.defs login.defs.before
mv login.defs1 login.defs
/bin/sed -e 's/PASS_MIN_LEN\s5/PASS_MIN_LEN\t8/g' login.defs > login.defs1
cp login.defs login.defs.before
mv login.defs1 login.defs

#####################################################################
cd /etc/
cp -p bashrc /etc/BackupSystemFiles/bashrc.prehard
# edit the line with umask
sed -e 's/umask 002/umask 022/g' bashrc >>bashrc1
cp -p bashrc bashrc.before
mv bashrc1 bashrc
echo "All the activities are done by this script has been logged into $HARD_LOG"

#####################Set Profile Umask ###################################

echo "umask 0022" >> /root/.bash_profile

source /root/.bash_profile

######################################SSH FILE #########################

sed -i 's/#Protocol 2/Protocol 2/g'  /etc/ssh/sshd_config
#sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config
#sed -i 's/#Protocol/Protocol/' /etc/ssh/sshd_config
#sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords no/' /etc/ssh/sshd_config
#sed -i 's/#IgnoreRhosts yes/IgnoreRhosts/' /etc/ssh/sshd_config
#sed -i 's/#ClientAliveCountMax 3 /ClientAliveCountMax 6/' /etc/ssh/sshd_config

################### YUM CONFIGURATION ##################################

#cd /etc/yum.repos.d/
#mv * /etc/BackupSystemFiles/backup.repo.prehard
#echo "Files have been copied to /etc/BackupSystemFiles " >>${HARD_LOG}

echo "##########################ADDITIONAL LINES############################" >>//etc/security/limits.conf
echo "*                soft    core            unlimited" >>//etc/security/limits.conf

######################################### RUNLEVEL#########################

echo " #######Change the default runlevel to multi user without X###############"
cd /etc/systemd/system
ls -l /etc/systemd/system/default.target | grep graphical.target 
unlink default.target
echo "###Setting multiuser target#####"
ln  -s  /usr/lib/systemd/system/multi-user.target  default.target
ls -l /etc/systemd/system/default.target

######## disable the ctrl + Alt + delete key combination, #################################

ln -sf /dev/null /etc/systemd/system/ctrl-alt-del.target 
systemctl mask ctrl-alt-del.target

#####globally desable CAD############

touch  /etc/dconf/db/local.d/00-disable-CAD 
echo " [org/gnome/settings-daemon/plugins/media-keys] "   >>/etc/dconf/db/local.d/00-disable-CAD
echo" logout=' ' "  >>/etc/dconf/db/local.d/00-disable-CAD

##########################NTP CONFIGURATION ###########################

yum install ntpd* -y
systemctl enable ntpd
systemctl start ntpd

sed -i 's/server 0.rhel.pool.ntp.org iburst/server idc1ntp.idc.ril.com /' /etc/ntp.conf
sed -i 's/server 1.rhel.pool.ntp.org iburst/server idc1ntp1.idc.ril.com /' /etc/ntp.conf
sed -i 's/server 2.rhel.pool.ntp.org iburst/#server 2.rhel.pool.ntp.org iburst/' /etc/ntp.conf
sed -i 's/server 3.rhel.pool.ntp.org iburst/#server 3.rhel.pool.ntp.org iburst/' /etc/ntp.conf

systemctl restart ntpd
/usr/sbin/ntpd -u ntp:ntp -g
ntpq -p

chkconfig --level 0123456 ntpd on
systemctl enable ntpd.service

timedatectl set-ntp true
hwclock --systohc --utc

ln -sf /usr/lib/systemd/system/ntpd.service /etc/systemd/system/multi-user.target.wants/ntpd.service


echo "##########################ADDITIONAL LINES##########################">>//etc/security/limits.conf
echo "*                soft    core            unlimited" >>//etc/security/limits.conf

for i in idcadm ; do useradd -ou 0 -g 0 $i; echo \ROX13r\!l5 | passwd --stdin $i ; done

echo "idcadm    ALL=(ALL)       ALL" >>/etc/sudoers


for i in rcadmin egadmin ; do adduser -o -u 0 -g 0 $i; echo p@ssw0rd | passwd --stdin $i ;
echo "User $i added successfully default password"
done


#echo "ROX13r!l5" | passwd --stdin idcadm
#AllowUsers admin root
#nest+dome-lessen


##########################################################
echo " umask 0022" >> /root/.cshrc

echo "All the activities are done by this script has been logged into $HARD_LOG"

for i in idcadm ; do useradd -ou 0 -g 0 $i; echo \ROX13r\!l5 | passwd --stdin $i ; done

echo "#======================================================================#"
echo
echo " END OF THE SCRIPT "
echo
echo "#======================================================================#" 

